import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

# Config
st.set_page_config(page_title="CARE Deficit Explorer", layout="wide")

st.title("CARE Deficit Explorer – Pre vs. Post Readiness Separation")

st.markdown("""
Compare original CARE funding vs. a reformed model where most fixed readiness costs are separated and funded centrally.
""")

# Sidebar
st.sidebar.header("Controls")

util_pct = st.sidebar.slider("Utilization (% of benchmark)", 50, 150, 70) / 100.0
staff_inc_pct = st.sidebar.slider("Staffing Increase (%)", 0, 30, 0) / 100.0
separation_pct = st.sidebar.slider("Readiness Costs Separated (%)", 0, 100, 80) / 100.0
leakage_max = st.sidebar.slider("Max Leakage at 0% Util ($M)", 0.0, 60.0, 30.0)

# Baseline constants
BASE_GROSS = 182.1
BASE_MILPAY = 104.7
BASE_FIXED = 178.6
REIMB = 0.0

# Calculations
gross = BASE_GROSS * util_pct * (1 + 0.6 * staff_inc_pct)
milpay = BASE_MILPAY * (1 + staff_inc_pct)
net_earned = gross - milpay + REIMB

leakage = leakage_max * max(0, 1 - util_pct)

# Pre-reform (original)
fixed_pre = BASE_FIXED * (1 + staff_inc_pct)
total_cost_pre = fixed_pre + leakage
deficit_pre = net_earned - total_cost_pre

# Post-reform (separated)
fixed_residual = BASE_FIXED * (1 - separation_pct) * (1 + staff_inc_pct)
total_cost_post = fixed_residual + leakage
deficit_post = net_earned - total_cost_post

# Statement of Operations Table
st.subheader("Statement of Operations ($ Millions)")

ops_data = {
    "Line Item": [
        "Gross CARE Value",
        "- Military Pay Offset",
        "+ Reimbursable",
        "= Net Earned Funding",
        "Fixed Readiness Costs (in CARE)",
        "Variable Leakage",
        "= Total Costs",
        "= Net Operating Position"
    ],
    "Original CARE": [
        round(gross, 1),
        round(-milpay, 1),
        REIMB,
        round(net_earned, 1),
        round(fixed_pre, 1),
        round(leakage, 1),
        round(total_cost_pre, 1),
        f"{deficit_pre:,.1f}"
    ],
    "After Separation": [
        round(gross, 1),
        round(-milpay, 1),
        REIMB,
        round(net_earned, 1),
        round(fixed_residual, 1),
        round(leakage, 1),
        round(total_cost_post, 1),
        f"{deficit_post:,.1f}"
    ]
}

df_ops = pd.DataFrame(ops_data)
st.dataframe(df_ops, use_container_width=True)

# Highlight net position
col1, col2 = st.columns(2)
with col1:
    st.metric("Original CARE Net Position", f"${deficit_pre:,.1f}M", delta_color="inverse" if deficit_pre < 0 else "normal")
with col2:
    st.metric("After Separation Net Position", f"${deficit_post:,.1f}M", delta_color="normal" if deficit_post >= 0 else "inverse")

# Sensitivity Chart
st.subheader("Net Position vs. Utilization – Pre vs. Post Separation")

util_range = np.linspace(0.5, 1.5, 21)
pre_curve = []
post_curve = []

for u in util_range:
    g = BASE_GROSS * u * (1 + 0.6 * staff_inc_pct)
    m = BASE_MILPAY * (1 + staff_inc_pct)
    n = g - m + REIMB
    l = leakage_max * max(0, 1 - u)
    
    # Pre
    f_pre = BASE_FIXED * (1 + staff_inc_pct)
    pre_curve.append(n - (f_pre + l))
    
    # Post
    f_post = BASE_FIXED * (1 - separation_pct) * (1 + staff_inc_pct)
    post_curve.append(n - (f_post + l))

fig, ax = plt.subplots(figsize=(10, 5))
ax.plot(util_range * 100, pre_curve, label="Original CARE", color="darkred", marker="o")
ax.plot(util_range * 100, post_curve, label="After Separation", color="darkgreen", marker="o")
ax.axhline(0, color="gray", linestyle="--")
ax.set_xlabel("Utilization (% of Benchmark)")
ax.set_ylabel("Net Position ($ Millions)")
ax.legend()
ax.grid(True, alpha=0.3)
st.pyplot(fig)

# Footer notes
st.caption("""
Assumptions: Earned value scales with utilization & staffing (sub-linear). Fixed costs grow with staffing.  
Separation removes the selected % of fixed readiness from CARE's equation (funded centrally).  
For demo only – based on FY2026 large MTF baseline.
""")
